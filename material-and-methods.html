<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>An integrated phenology modelling framework in R</title>
  <meta name="description" content="An integrated phenology modelling framework in R">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="An integrated phenology modelling framework in R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="An integrated phenology modelling framework in R" />
  
  
  

<meta name="author" content="Koen Hufkens, David Bassler, Tom milliman, Eli Melaas, Andrew D. Richardson">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="introduction.html">
<link rel="next" href="discussion.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="material-and-methods.html"><a href="material-and-methods.html"><i class="fa fa-check"></i><b>3</b> Material and Methods</a><ul>
<li class="chapter" data-level="3.1" data-path="material-and-methods.html"><a href="material-and-methods.html#the-phenor-r-package"><i class="fa fa-check"></i><b>3.1</b> The phenor R package</a></li>
<li class="chapter" data-level="3.2" data-path="material-and-methods.html"><a href="material-and-methods.html#a-worked-example-a-quick-model-comparison"><i class="fa fa-check"></i><b>3.2</b> A worked example: a quick model comparison</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>4</b> Discussion</a></li>
<li class="chapter" data-level="5" data-path="known-limitations.html"><a href="known-limitations.html"><i class="fa fa-check"></i><b>5</b> Known limitations</a></li>
<li class="chapter" data-level="6" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>6</b> Conclusion</a></li>
<li class="chapter" data-level="7" data-path="contributions.html"><a href="contributions.html"><i class="fa fa-check"></i><b>7</b> Contributions</a></li>
<li class="chapter" data-level="8" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i><b>8</b> Acknowledgements</a></li>
<li class="chapter" data-level="9" data-path="code-data-availability.html"><a href="code-data-availability.html"><i class="fa fa-check"></i><b>9</b> Code &amp; Data availability</a></li>
<li class="chapter" data-level="10" data-path="reference.html"><a href="reference.html"><i class="fa fa-check"></i><b>10</b> Reference</a></li>
<li class="chapter" data-level="11" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>11</b> APPENDIX</a><ul>
<li class="chapter" data-level="11.1" data-path="appendix.html"><a href="appendix.html#the-phenocam-network-data-processing-and-selection"><i class="fa fa-check"></i><b>11.1</b> The PhenoCam network, data processing and selection</a></li>
<li class="chapter" data-level="11.2" data-path="appendix.html"><a href="appendix.html#the-phenocamr-r-package-methodology"><i class="fa fa-check"></i><b>11.2</b> The phenocamr R package: methodology</a><ul>
<li class="chapter" data-level="11.2.1" data-path="appendix.html"><a href="appendix.html#outlier-detection-and-smoothing"><i class="fa fa-check"></i><b>11.2.1</b> Outlier detection and smoothing</a></li>
<li class="chapter" data-level="11.2.2" data-path="appendix.html"><a href="appendix.html#phenophase-estimation"><i class="fa fa-check"></i><b>11.2.2</b> Phenophase estimation</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="appendix.html"><a href="appendix.html#the-phenocamr-r-package-usage"><i class="fa fa-check"></i><b>11.3</b> The phenocamr R package: usage</a></li>
<li class="chapter" data-level="11.4" data-path="appendix.html"><a href="appendix.html#the-daymetr-r-package"><i class="fa fa-check"></i><b>11.4</b> The daymetr R package</a></li>
<li class="chapter" data-level="11.5" data-path="appendix.html"><a href="appendix.html#worked-example-statistical-results"><i class="fa fa-check"></i><b>11.5</b> Worked example statistical results</a></li>
<li class="chapter" data-level="11.6" data-path="appendix.html"><a href="appendix.html#references"><i class="fa fa-check"></i><b>11.6</b> References</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An integrated phenology modelling framework in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="material-and-methods" class="section level1">
<h1><span class="header-section-number">3</span> Material and Methods</h1>
<div id="the-phenor-r-package" class="section level2">
<h2><span class="header-section-number">3.1</span> The phenor R package</h2>
<p>The phenor R package assimilates four important phenological records of either observational, near-surface and satellite remote sensing based records across a variety of ecosystem and plant functional types. The phenor R package combines data from near-surface remote sensing through the PhenoCam network using phenocamr and daymetr R packages into a phenology modelling framework which covers data preparation, model optimization and model visualization and consists of a number of key functions. In addition, data from the USA National Phenology Network (USA-NPN), the Pan European Phenology Project (PEP725) and the MODIS land surface phenology product (MCD12Q2) can be ingested. In the interest of brevity both phenocamr, daymetr R packages and the PhenoCam source data are described in Appendix S1.</p>
<p>The format_phenocam() phenor function combines phenophases, downloaded and generated by the phenocamr R package, with the climate data downloaded using the daymetr R package. The function requires the location (path) of the generated phenophase output files, together with parameters specifying the phenophase (direction = rising; with rising for spring or falling for autumn) and the threshold value used (threshold = 25), the Gcc percentile to use (gcc_value = 90, Sonnentag et al. 2012) and the offset as a day-of-year value. The offset is the day-of-year in the previous year on which to start reporting climate data, running until this day in the subsequent year. The function returns model calibration/validation and driver data a nested list of data frames (df), used in subsequent model optimization (see description of optimize_parameters() and model_calibration() below).</p>
<pre><code>df = format_phenocam( path = “/path/to/phenocamr/phenophases/”,
                           direction = “rising”,
                           gcc_value =  “gcc_90”,
               threshold = 25,
                           offset = 264)</code></pre>
<p>Similarly, the format_pep725() function uses PEP725 observational data together with European E-OBS climate data (Haylock et al. 2008) to compile a consistent calibration/validation dataset for European observational records (e.g., Basler 2016). Data can be downloaded using the download_pep725() function. We provide similar functionality for the USA-NPN data. Data can be downloaded through the USA-NPN application programming interface using download_npn() and correctly formatted with format_npn(). Furthermore, the format_modis() function correctly formats a directory of MODIS MCD12Q2 land surface phenology data (i.e., phenophases, Zhang et al. 2003) as downloaded with the MODISTools R package (Tuck et al. 2014).</p>
<p>Spatially scaling of model results is facilitated through a number of functions. The format_daymet() function uses gridded pre-processed Daymet tiles to generate spatially explicit driver data (download_daymet_tiles() and daymet_tmean() functions of daymetr, Appendix S1). The format_eobs() function provides the same functionality for the E-OBS climate data. Yet another source of hindcast data is compiled using the format_berkeley_earth() function, which allows the user to subset 1x1 degree global historical climate data for any year since 1850 through the Berkeley Earth project (Rohde et al. 2012). Similarly, the format_cmip5() function formats 1/4th degree NASA Earth Exchange (NEX) global gridded Coupled Model Intercomparison Project (CMIP5) data of historical reanalysis and representative concentration pathway (RCP 4.5 and RCP8.5) projections. Unlike format_phenocam() or format_modis() no calibration/validation data is included in the gridded spatial data.</p>
<p>The resulting dataset of all formatting functions is a nested list with the following layout:</p>
<pre><code>phenor_data_structure
    └─── doy (vector)
    └─── site (vector, NULL for spatial data)
    └─── location (matrix, latitude and longitude by row)
    └─── ltm (vector, value: degrees C)
    └─── Ti (matrix, columns: years, rows: doy, value: degrees C)
    └─── Tmaxi (matrix, columns: years, rows: doy, value: degrees C)
    └─── Tmini (matrix, columns: years, rows: doy, value: degrees C)
    └─── Li (matrix, columns: years, rows: doy, value: hours/day)
    └─── VPDi (matrix, columns: years, rows: doy, value: Pa)
    └─── Pi (matrix, columns: years, rows: doy, value: mm/day)
    └─── transition_dates (vector, NULL for spatial data)
    └─── georeferencing (NULL for PhenoCam, MODIS, USA-NPN or PEP725 data)
        └─── size (size of the spatial data)
        └─── extent (extent of the spatial data)
        └─── projection (projection of the spatial data)</code></pre>
<p>Within the phenor data structure the top level is a particular site. For each site critical parameters such as the day-of-year range (doy, as specified by the offset), the geographic location (or georeferencing), and matrices holding, minimum temperature (Tmini), maximum temperature (Tmaxi) and mean daily temperature (Ti), precipitation (Pi), vapour pressure deficit (VPDi), daylength in hours (Li), and calibration/validation transition date (transition_dates) data are provided. Matrices are organized with columns representing a given year, and rows representing a given day-of-year. Other data are represented as vectors matching the number of columns present in the climate data matrices. Where necessary, data is truncated to match the available climate data. When certain data sources are missing the content of a field is set to NULL.</p>
<p>The optimize_parameters() function in the package allows for the easy optimization of model parameters. This function uses two common optimizers, GenSA (Xiang et al. 2013) and rgenoud (Mebane &amp; Sekhon 2011). The GenSA algorithm combines both the Boltzmann machine and faster Cauchy machine simulated annealing approaches for fast optimizations (Tsallis &amp; Stariolo 1995), while the genoud routine combines an evolutionary algorithm with a derivative based (quasi-Newton) method to solve difficult optimization problems (Mebane &amp; Sekhon 2011). To optimize a calibration/validation dataset (df) one specifies a particular model (e.g., the Thermal Time model, TT), a defined optimizer (e.g., GenSA), an objective function such the root mean squared error (RMSE) and upper-lower parameter limits as well as parameter starting values when required. Additional control parameters, such as the maximum number or iterations (e.g., max.call), can be provided using a list of options to the control parameter. An example function call to optimize a the TT model is provided below.</p>
<pre><code>optimal_par = optimize_parameters( par = NULL,
                    data = df,
                    cost = rmse,
                    model = “TT”,
                    method = “GenSA”,
                    lower = c(1,-5,0),
                                    upper = c(365,10,2000),
                    control = list(max.call = 40000))</code></pre>
<p>Final predicted values for the optimized parameters can be retrieved by running the estimate_phenology() function with the optimized parameters.</p>
<pre><code>results = estimate_phenology(par = optimal_par$par,
                    data = df,
                    model = “TT”)</code></pre>
<p>The output will automatically be formatted as a map of phenology dates or a vector, depending on the input data class. However, running models across all grid cells of spatial data would provide a naively broad representation of land surface phenology. For example, only a small subset of the US is dominated by any particular plant functional type (PFT), such as deciduous broadleaf forests. In order to better differentiate between different dominant PFT we include a function land_cover_density() which calculates the percentage coverage of a particular MODIS MCD12Q1 IGBP land cover class (Friedl et al. 2010) within a given raster cell for a given location (i.e., CMIP5 data, see Figure @ref(fig:spatial_scaling)).</p>
<p>A wrapper function, model_calibration(), is provided for both the optimize_parameters() and estimate_phenology() functions which integrates the previously described steps providing both summary statistics (RMSE and AICc) and a plot (Figure <a href="material-and-methods.html#fig:validation">3.1</a> ) of the model fit. Likewise, the model_comparison() function serves as a wrapper for multi-model parameter optimization runs. For a visual comparison limited to two model runs we provide an arrow plot function, arrow_plot(), displaying directional changes in the modelled values between the model outputs (Figure <a href="material-and-methods.html#fig:arrow">3.2</a> ).</p>
<div class="figure"><span id="fig:validation"></span>
<img src="output/Figure_1_model_validation.png" alt="Model calibration output" width="1050" />
<p class="caption">
Figure 3.1: Model calibration output
</p>
</div>
<div class="figure"><span id="fig:arrow"></span>
<img src="output/Figure_2_arrow_plot.png" alt="Arrow plot" width="1050" />
<p class="caption">
Figure 3.2: Arrow plot
</p>
</div>
</div>
<div id="a-worked-example-a-quick-model-comparison" class="section level2">
<h2><span class="header-section-number">3.2</span> A worked example: a quick model comparison</h2>
<p>As a worked example we partially recreate the spring phenology model comparison by Basler (2016) using PhenoCam data. However, we note that a similar exercise could be executed with any of the other phenology data sources available through phenor. The model structures included in this worked example can be described by the three broad categories: (1) as simple linear regression to spring temperature (2) models explaining ecodormancy release only, (3) models explaining the release of endo- and ecodormancy. A reference NULL model assumes a fixed mean date of leaf unfolding.</p>
<p>A total of 22 phenology models are included in the package (table 1). These include 20 spring phenology models including precipitation driven models, one fall senescence chilling degree day model and one grassland pollen release model. In our worked example of the phenor R package we will focus only on the 20 spring phenology models. A full list of the model structures and parameter ranges for the models are provided in Table 2 of Appendix S2 and included in the phenor library.</p>
<p>TABLE 1</p>
<p>For this study we combined spring phenology dates based on PhenoCam 3-day summary data from the standardized PhenoCam Dataset (Richardson et al. 2017) with Daymet data (Thornton et al. 2017) for three common PFTs, deciduous broadleaf forests, evergreen needleleaf forest and grasslands. A total of 102 sites and 508 site years were included in our calibration/validation dataset, of which 63 were deciduous broadleaf forest sites (358 site years), 18 were evergreen needleleaf forest sites (63 site years) and 21 were grasslands (88 site years). Deciduous broadleaf sites which are moisture limited, and all sites outside Daymet coverage, were excluded from our analysis. The final selected sites span a large geographic area ranging from New Mexico to Southern Alaska, and Maine to California (Figure <a href="material-and-methods.html#fig:location">3.3</a>).</p>
<div class="figure"><span id="fig:location"></span>
<img src="output/Figure_3_site_location_map.png" alt="Site locations" width="1350" />
<p class="caption">
Figure 3.3: Site locations
</p>
</div>
<p>We acknowledge that phenological development as measured using PhenoCam data represent different physiological processes for different PFTs. For example, the phenology of deciduous forests or grasslands is closely linked to the development of new leaf tissues (Keenan et al. 2014; Hufkens et al. 2016) where evergreen forest phenology is determined by dehardening of existing needles at the end of the winter season. Thus, optimized model parameters and their interpretation are specific to each PFT.</p>
<p>For all PFTs, model optimization were executed using the default generalized simulated annealing (GenSA) package minimizing the RMSE between the greenness rising PhenoCam phenophase estimations and model predictions (see Appendix S1). The optimizer was run for 40 000 iterations with a starting temperature of 10 000. To determine the influence of locations at the margin of the forest biome on model optimizations a subset of sites centrally located within the deciduous forest biome was created (Melaas et al. 2016, Appendix S2 Table 2). This subset was optimized separately and compared to results for the complete deciduous broadleaf dataset. We assess proper convergence of the optimized parameters by initializing the optimizer using 12 random sets of parameters. We report mean and standard deviations of the RMSE between observations and predictions on the optimized parameter values for all PFTs and the subset generated for deciduous forest sites. We compare model performance with a log transformed ANOVA, combined with a post-hoc Tukey HSD test. Model errors are evaluated for normality using a Shapiro-Wilk test.</p>
<p>For illustrative purposes we produce overview maps (Figure @ref(fig:spatial_scaling)) of spatial patterns both in hindcast and forecast mode. In hindcast mode we use 1x1 km Daymet gridded data across New England, while we present the difference in predicted spring phenology (ΔDOY) between years 2100 and 2011 for forecast CMIP5 IPSL-CM5A-MR (Mid-Resolution Institut Pierre Simon Laplace Climate Model 5) model runs, across the contiguous US. The Thermal Time (TT) and Accumulated Growing Season Index models were optimized for deciduous broadleaf and grassland PhenoCam data, respectively. For forecast data only pixels dominated by their particular PFT are displayed, limiting a naively broad interpretation of the results.</p>
<p>Our comparison of 20 spring phenology models across three PFT showed that most models were significantly different from the NULL model, with the exception of the SGSI model in the evergreen PFT (post-hoc Tukey HSD test, p &lt; 0.001, Figure <a href="material-and-methods.html#fig:comparison">3.4</a>). The model performance of the centrally located deciduous broadleaf sites was marginally greater (RMSE: ~7.6±0.7 days) compared to the complete deciduous broadleaf dataset (RMSE: ~7.9±1.2 days). This difference between the full deciduous broadleaf forest dataset and those more centrally within the biome suggests an influence of geographic location on model error.</p>
<div class="figure"><span id="fig:comparison"></span>
<img src="output/Figure_4_model_comparison.png" alt="model comparison" width="1200" />
<p class="caption">
Figure 3.4: model comparison
</p>
</div>
<p>The influence of different model structures on individual values was visualized using the arrow plot (Figure <a href="material-and-methods.html#fig:arrow">3.2</a>) between two model runs. When visually comparing the Thermal Time (TT) and the Photothermal Time (PTT) models small changes are noted (<a href="material-and-methods.html#fig:arrow">3.2</a>). Both models accumulate growing degree days where the PTT model adds a photoperiod component to the original TT model. In the PTT model leaf unfolding is therefore in part dependent on a daylength requirement in addition to thermal forcing. In our example, the addition of a daylength requirement shifts model results for early and late developing plants toward earlier leaf out dates, while at the same time shifting mid season developing plants toward later leaf out dates. Despite these changes overall model accuracy remains the same. A description of all statistical results is provided in Appendix S1, section 5.</p>
<div class="figure">
<img src="output/Figure_5_spatial_runs.png" alt="spatial scaling" width="1800" />
<p class="caption">
(#fig:spatial_scaling)spatial scaling
</p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="discussion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "twitter"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

</body>

</html>
